#!/bin/bash

backup_folder_name=$(echo "{{ gluster_backup_dir }}/$(date +"%Y-%m-%d-%H-%M")")
mongodb_host="{{ groups.mongodb_config[0]}}.{{ domain }}"
mongodb_port="{{ mongodb_router_port }}"
mongodb_user="{{ mongodb_user_backup }}"
mongodb_pass="{{ mongodb_user_backup_pass }}"
mongodb_authdb=admin
mongodb_backup_db="{{ cer_db }}"

#понеслась
echo $date "Запущено резервное копирование" >> /var/log/mongobackup.log
echo $backup_folder_name  >> /var/log/mongobackup.log
mkdir $backup_folder_name
mongodump --gzip --port $mongodb_port --host $mongodb_host --username $mongodb_user --password $mongodb_pass --authenticationDatabase $mongodb_authdb --db $mongodb_backup_db --out $backup_folder_name  >> /var/log/mongobackup.log
if [[ $? != 0 ]]
  then
    echo $date "Бекап успешно завершен" >> /var/log/mongobackup.log
    exit 0
  else
    echo $date "Операция завершена с ошибкой" >> /var/log/mongobackup.log
    exit 1
fi